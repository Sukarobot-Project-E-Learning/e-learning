name: Deploy E-Learning to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: E-Learning VPS Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script: |
          cd /var/www/e-learning

          echo "ðŸŽ“ E-Learning Deployment Started..."
          echo "ðŸ“¦ Pulling latest changes from Git..."

          # Pull latest changes (only changed files)
          git pull origin main

          echo "ðŸ“¦ Installing NPM dependencies..."
          npm ci

          echo "ðŸ”¨ Building Vite assets..."
          npm run build

          echo "ðŸ”§ Setting permissions..."
          sudo chown -R www-data:www-data /var/www/e-learning
          sudo chmod -R 755 /var/www/e-learning
          sudo chmod -R 775 /var/www/e-learning/storage
          sudo chmod -R 775 /var/www/e-learning/bootstrap/cache

          echo "ï¿½ Creating storage symlink..."
          sudo -u www-data php artisan storage:link --force 2>/dev/null || echo "Storage link already exists"

          echo "ðŸ§¹ Clearing and optimizing caches..."
          sudo -u www-data php artisan optimize:clear
          sudo -u www-data php artisan config:cache
          sudo -u www-data php artisan route:cache
          sudo -u www-data php artisan view:cache

          echo "âœ… E-Learning deployment completed!"
